!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var o in n)("object"==typeof exports?exports:t)[o]=n[o]}}(self,(function(){return(()=>{var t={675:function(t,e){(function(){var t,n,o,s,i={}.hasOwnProperty,r=[].slice;t={LF:"\n",NULL:"\0"},o=function(){var e;function n(t,e,n){this.command=t,this.headers=null!=e?e:{},this.body=null!=n?n:""}return n.prototype.toString=function(){var e,o,s,r,c;for(o in e=[this.command],(s=!1===this.headers["content-length"])&&delete this.headers["content-length"],c=this.headers)i.call(c,o)&&(r=c[o],e.push(o+":"+r));return this.body&&!s&&e.push("content-length:"+n.sizeOfUTF8(this.body)),e.push(t.LF+this.body),e.join(t.LF)},n.sizeOfUTF8=function(t){return t?encodeURI(t).match(/%..|./g).length:0},e=function(e){var o,s,i,r,c,a,u,l,d,p,h,f,m,b,g,v,y;for(r=e.search(RegExp(""+t.LF+t.LF)),i=(c=e.substring(0,r).split(t.LF)).shift(),a={},f=function(t){return t.replace(/^\s+|\s+$/g,"")},m=0,g=(v=c.reverse()).length;m<g;m++)l=(p=v[m]).indexOf(":"),a[f(p.substring(0,l))]=f(p.substring(l+1));if(o="",h=r+2,a["content-length"])d=parseInt(a["content-length"]),o=(""+e).substring(h,h+d);else for(s=null,u=b=h,y=e.length;(h<=y?b<y:b>y)&&(s=e.charAt(u))!==t.NULL;u=h<=y?++b:--b)o+=s;return new n(i,a,o)},n.unmarshall=function(n){var o;return function(){var s,i,r,c;for(c=[],s=0,i=(r=n.split(RegExp(""+t.NULL+t.LF+"*"))).length;s<i;s++)(null!=(o=r[s])?o.length:void 0)>0&&c.push(e(o));return c}()},n.marshall=function(e,o,s){return new n(e,o,s).toString()+t.NULL},n}(),n=function(){var e;function n(t){this.ws=t,this.ws.binaryType="arraybuffer",this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.maxWebSocketFrameSize=16384,this.subscriptions={}}return n.prototype.debug=function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.console)?e.log(t):void 0},e=function(){return Date.now?Date.now():(new Date).valueOf},n.prototype._transmit=function(t,e,n){var s;for(s=o.marshall(t,e,n),"function"==typeof this.debug&&this.debug(">>> "+s);;){if(!(s.length>this.maxWebSocketFrameSize))return this.ws.send(s);this.ws.send(s.substring(0,this.maxWebSocketFrameSize)),s=s.substring(this.maxWebSocketFrameSize),"function"==typeof this.debug&&this.debug("remaining = "+s.length)}},n.prototype._setupHeartbeat=function(n){var o,i,r,c,a,u;if((a=n.version)===s.VERSIONS.V1_1||a===s.VERSIONS.V1_2)return i=(u=function(){var t,e,o,s;for(s=[],t=0,e=(o=n["heart-beat"].split(",")).length;t<e;t++)c=o[t],s.push(parseInt(c));return s}())[0],o=u[1],0!==this.heartbeat.outgoing&&0!==o&&(r=Math.max(this.heartbeat.outgoing,o),"function"==typeof this.debug&&this.debug("send PING every "+r+"ms"),this.pinger=s.setInterval(r,function(e){return function(){return e.ws.send(t.LF),"function"==typeof e.debug?e.debug(">>> PING"):void 0}}(this))),0!==this.heartbeat.incoming&&0!==i?(r=Math.max(this.heartbeat.incoming,i),"function"==typeof this.debug&&this.debug("check PONG every "+r+"ms"),this.ponger=s.setInterval(r,function(t){return function(){var n;if((n=e()-t.serverActivity)>2*r)return"function"==typeof t.debug&&t.debug("did not receive server activity for the last "+n+"ms"),t.ws.close()}}(this))):void 0},n.prototype._parseConnect=function(){var t,e,n,o;switch(o={},(t=1<=arguments.length?r.call(arguments,0):[]).length){case 2:o=t[0],e=t[1];break;case 3:t[1]instanceof Function?(o=t[0],e=t[1],n=t[2]):(o.login=t[0],o.passcode=t[1],e=t[2]);break;case 4:o.login=t[0],o.passcode=t[1],e=t[2],n=t[3];break;default:o.login=t[0],o.passcode=t[1],e=t[2],n=t[3],o.host=t[4]}return[o,e,n]},n.prototype.connect=function(){var n,i,c,a;return n=1<=arguments.length?r.call(arguments,0):[],a=this._parseConnect.apply(this,n),c=a[0],this.connectCallback=a[1],i=a[2],"function"==typeof this.debug&&this.debug("Opening Web Socket..."),this.ws.onmessage=function(n){return function(s){var r,c,a,u,l,d,p,h,f,m,b,g;if(u="undefined"!=typeof ArrayBuffer&&s.data instanceof ArrayBuffer?(r=new Uint8Array(s.data),"function"==typeof n.debug&&n.debug("--- got data length: "+r.length),function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)c=r[t],n.push(String.fromCharCode(c));return n}().join("")):s.data,n.serverActivity=e(),u!==t.LF){for("function"==typeof n.debug&&n.debug("<<< "+u),g=[],f=0,m=(b=o.unmarshall(u)).length;f<m;f++)switch((l=b[f]).command){case"CONNECTED":"function"==typeof n.debug&&n.debug("connected to server "+l.headers.server),n.connected=!0,n._setupHeartbeat(l.headers),g.push("function"==typeof n.connectCallback?n.connectCallback(l):void 0);break;case"MESSAGE":h=l.headers.subscription,(p=n.subscriptions[h]||n.onreceive)?(a=n,d=l.headers["message-id"],l.ack=function(t){return null==t&&(t={}),a.ack(d,h,t)},l.nack=function(t){return null==t&&(t={}),a.nack(d,h,t)},g.push(p(l))):g.push("function"==typeof n.debug?n.debug("Unhandled received MESSAGE: "+l):void 0);break;case"RECEIPT":g.push("function"==typeof n.onreceipt?n.onreceipt(l):void 0);break;case"ERROR":g.push("function"==typeof i?i(l):void 0);break;default:g.push("function"==typeof n.debug?n.debug("Unhandled frame: "+l):void 0)}return g}"function"==typeof n.debug&&n.debug("<<< PONG")}}(this),this.ws.onclose=function(t){return function(){var e;return e="Whoops! Lost connection to "+t.ws.url,"function"==typeof t.debug&&t.debug(e),t._cleanUp(),"function"==typeof i?i(e):void 0}}(this),this.ws.onopen=function(t){return function(){return"function"==typeof t.debug&&t.debug("Web Socket Opened..."),c["accept-version"]=s.VERSIONS.supportedVersions(),c["heart-beat"]=[t.heartbeat.outgoing,t.heartbeat.incoming].join(","),t._transmit("CONNECT",c)}}(this)},n.prototype.disconnect=function(t,e){return null==e&&(e={}),this._transmit("DISCONNECT",e),this.ws.onclose=null,this.ws.close(),this._cleanUp(),"function"==typeof t?t():void 0},n.prototype._cleanUp=function(){if(this.connected=!1,this.pinger&&s.clearInterval(this.pinger),this.ponger)return s.clearInterval(this.ponger)},n.prototype.send=function(t,e,n){return null==e&&(e={}),null==n&&(n=""),e.destination=t,this._transmit("SEND",e,n)},n.prototype.subscribe=function(t,e,n){var o;return null==n&&(n={}),n.id||(n.id="sub-"+this.counter++),n.destination=t,this.subscriptions[n.id]=e,this._transmit("SUBSCRIBE",n),o=this,{id:n.id,unsubscribe:function(){return o.unsubscribe(n.id)}}},n.prototype.unsubscribe=function(t){return delete this.subscriptions[t],this._transmit("UNSUBSCRIBE",{id:t})},n.prototype.begin=function(t){var e,n;return n=t||"tx-"+this.counter++,this._transmit("BEGIN",{transaction:n}),e=this,{id:n,commit:function(){return e.commit(n)},abort:function(){return e.abort(n)}}},n.prototype.commit=function(t){return this._transmit("COMMIT",{transaction:t})},n.prototype.abort=function(t){return this._transmit("ABORT",{transaction:t})},n.prototype.ack=function(t,e,n){return null==n&&(n={}),n["message-id"]=t,n.subscription=e,this._transmit("ACK",n)},n.prototype.nack=function(t,e,n){return null==n&&(n={}),n["message-id"]=t,n.subscription=e,this._transmit("NACK",n)},n}(),s={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(t,e){var o;return null==e&&(e=["v10.stomp","v11.stomp"]),o=new(s.WebSocketClass||WebSocket)(t,e),new n(o)},over:function(t){return new n(t)},Frame:o},null!==e&&(e.Stomp=s),"undefined"!=typeof window&&null!==window?(s.setInterval=function(t,e){return window.setInterval(e,t)},s.clearInterval=function(t){return window.clearInterval(t)},window.Stomp=s):e||(self.Stomp=s)}).call(this)}},e={};function n(o){var s=e[o];if(void 0!==s)return s.exports;var i=e[o]={exports:{}};return t[o].call(i.exports,i,i.exports,n),i.exports}n.d=(t,e)=>{for(var o in e)n.o(e,o)&&!n.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};return(()=>{"use strict";n.r(o),n.d(o,{StompBehavior:()=>i,WxStompClient:()=>e,wxStompClient:()=>s});var t=n(675);t.Stomp.setInterval=function(t,e){return setInterval(e,t)},t.Stomp.clearInterval=function(t){return clearInterval(t)};class e extends class{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[t]&&(n[t]=[]),-1===n[t].indexOf(e)&&n[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[t]&&-1!==n[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const n=this._listeners[t];if(void 0!==n){const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const n=e.slice(0);for(let e=0,o=n.length;e<o;e++)n[e].call(this,t)}}}{socketTask;stompClient;autoConnect=!0;autoConnectTimeout=15e3;socketConfig;stompConnectConfig;stompWs;autoConnectTimerId;connected=!1;doAutoConnect(t){let e=this,n=t?0:e.autoConnectTimeout;t&&(e.autoConnect=!0),clearTimeout(e.autoConnectTimerId),e.autoConnect&&(console.debug("try auto connect timeout ["+n+"]ms"),e.autoConnectTimerId=setTimeout((()=>{e.connect(e.socketConfig,e.stompConnectConfig)}),n))}_init(){let e=this;e.stompWs={send:t=>new Promise(((n,o)=>{e.socketTask&&1===e.socketTask.readyState?e.socketTask.send({data:t,success(){n()},fail(){o()}}):o("socketTask is not open")})),close(){if(e.socketTask)try{e.socketTask.close()}catch(t){console.log(t)}}},e.stompClient=t.Stomp.over(e.stompWs),e.stompClient.debug=console.debug}constructor(t=!0,e=15e3){super(),this.autoConnect=t,this.autoConnectTimeout=e}connect(t,e={}){let n=this;if(n.socketConfig=t,n.stompConnectConfig=e,console.debug("stomp connect",t,e),!n.connected){this._init(),n.socketTask=wx.connectSocket({...t,success(t){n.stompClient.connect(e,(function(t){console.debug("stomp connect success"),n.connected=!0,n.dispatchEvent({type:"stomp-connected",data:t})}),(t=>{console.debug("stomp connect error"),n.connected=!1,n.dispatchEvent({type:"stomp-connect-error",data:t}),n.doAutoConnect()}))},fail(t){console.log(t),n.doAutoConnect(),n.connected=!1}});try{n.socketTask.onClose((function(t){console.debug("socketTask.onClose",t),n.connected=!1,n.dispatchEvent({type:"socket-close",data:t}),n.stompClient&&(n.stompClient.connected=!1,n.stompClient.disconnect()),n.stompClient=null,n.socketTask=null,n.doAutoConnect()}))}catch(t){console.error(t)}try{n.socketTask.onOpen((function(t){console.debug("WebSocket连接已打开！"),n.dispatchEvent({type:"socket-open",data:t}),n.stompWs.onopen&&n.stompWs.onopen()}))}catch(t){console.error(t)}try{n.socketTask.onMessage((function(t){n.stompWs.onmessage&&n.stompWs.onmessage(t)}))}catch(t){console.error(t)}}}close(){if(this.autoConnect=!1,this.socketTask)try{this.socketTask.close()}catch(t){console.log(t)}}}const s=new e;let i=Behavior({behaviors:[],attached:function(){let t=this;t.setData({_wxStompClient:s,_stompConnected:s.connected,stomp_map:new Map}),s.addEventListener("socket-close",t.__stompSocketCloseEventListener),s.addEventListener("stomp-connected",t.__stompConnectedEventListener)},detached(){s.removeEventListener("socket-close",this.__stompSocketCloseEventListener),s.removeEventListener("stomp-connected",this.__stompConnectedEventListener);let t=this.data.stomp_map;for(let[e,n]of t)n.unsubscribe(),console.debug("取消订阅["+e+"]====>"+n.id);console.groupEnd(),t.clear()},data:{},methods:{__stompSocketCloseEventListener(){this.setData({_stompConnected:!1}),console.debug("__stompSocketCloseEventListener")},__stompConnectedEventListener(){this.setData({_stompConnected:!0}),console.debug("__stompConnectedEventListener");for(let[t,e]of new Map(this.data.stomp_map))e.callback&&(console.debug("重新订阅"+t),this._stompSubscribe(t,e.callback))},_stompUnsubscribe(t){let e=this;if(e.data.stomp_map.has(t)){let n=e.data.stomp_map.get(t);n.unsubscribe&&n.unsubscribe(),console.debug("取消订阅["+t+"]====>"+n.id),e.data.stomp_map.delete(t)}},_stompSubscribe(t,e){let n=this;s.connected?(n._stompUnsubscribe(t),console.debug("订阅-----------------------["+t+"]"),n.data.stomp_map.set(t,Object.assign(s.stompClient.subscribe(t,(t=>{e(t)})),{callback:e}))):setTimeout((()=>{n._stompSubscribe(t,e)}),15e3),console.groupEnd()},_stompSend(){return s.connected?s.stompClient.send(...arguments):Promise.reject("stomp not connected")}}})})(),o})()}));